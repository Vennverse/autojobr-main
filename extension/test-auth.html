<!DOCTYPE html>
<html>
<head>
    <title>AutoJobr Extension Authentication Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>AutoJobr Extension Authentication Test</h1>
    
    <button onclick="testTokenGeneration()">Test Token Generation</button>
    <button onclick="testExtensionUser()">Test Extension User Endpoint</button>
    <button onclick="testFullFlow()">Test Full Authentication Flow</button>
    <button onclick="clearStorage()">Clear Local Storage</button>
    
    <div id="results"></div>

    <script>
        const API_BASE = 'http://40.160.50.128';
        
        function addResult(message, isSuccess = false) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${isSuccess ? 'success' : 'error'}`;
            resultDiv.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            resultsDiv.appendChild(resultDiv);
        }

        async function testTokenGeneration() {
            try {
                addResult('Testing token generation...');
                
                const response = await fetch(`${API_BASE}/api/auth/extension-token`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('autojobr_extension_token', data.token);
                    addResult(`✅ Token generated successfully: ${data.token.substring(0, 16)}...`, true);
                } else {
                    const errorText = await response.text();
                    addResult(`❌ Token generation failed (${response.status}): ${errorText}`);
                }
            } catch (error) {
                addResult(`❌ Token generation error: ${error.message}`);
            }
        }

        async function testExtensionUser() {
            try {
                const token = localStorage.getItem('autojobr_extension_token');
                if (!token) {
                    addResult('❌ No token found. Generate one first.');
                    return;
                }

                addResult('Testing extension user endpoint...');
                
                const response = await fetch(`${API_BASE}/api/extension/user?token=${token}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-Extension-Token': token
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    addResult(`✅ User data retrieved: ${userData.email}`, true);
                } else {
                    const errorText = await response.text();
                    addResult(`❌ User endpoint failed (${response.status}): ${errorText}`);
                }
            } catch (error) {
                addResult(`❌ User endpoint error: ${error.message}`);
            }
        }

        async function testFullFlow() {
            addResult('Starting full authentication flow test...');
            
            // Step 1: Generate token
            await testTokenGeneration();
            
            // Step 2: Wait a moment
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Step 3: Test user endpoint
            await testExtensionUser();
        }

        function clearStorage() {
            localStorage.removeItem('autojobr_extension_token');
            addResult('✅ Local storage cleared', true);
        }
    </script>
</body>
</html>